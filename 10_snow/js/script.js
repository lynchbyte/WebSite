import*as THREE from"https://unpkg.com/three@0.133.1/build/three.module.js";import{GLTFLoader}from"./GLTFLoader.js";const gltfLoader=new GLTFLoader,textureLoader=new THREE.TextureLoader,glbScl=.3,sound=new Howl({src:["media/audio/o-christmas-tree.ogg"],volume:.25});let controller,hitTestSource=null,hitTestSourceRequested=!1;const clock=new THREE.Clock,canvas=document.querySelector("canvas.webgl");export const scene=new THREE.Scene;export const globeGroup=new THREE.Group;export const boxSnowArray=[];const shakeEvent=new Shake({threshold:5});shakeEvent.start(),"ondevicemotion"in window||alert("Shaking Not Supported on this device");let globeNext,still=!0,clampHeight=.3,stars=!1,treePresenet=!1;const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.01,20);camera.position.set(0,0,2),scene.add(camera);const hemi=new THREE.HemisphereLight(16777215,16777215,.3);hemi.position.set(0,-1,0),scene.add(hemi),hemi.name="Hemi";const lightD=new THREE.DirectionalLight(16773341,1.4);lightD.position.set(2,0,1.5),lightD.castShadow=!0,lightD.shadow.mapSize.width=1024,lightD.shadow.mapSize.height=1024,lightD.shadow.camera.near=1,lightD.shadow.camera.far=6,lightD.shadow.camera.top=2,lightD.shadow.camera.right=2,lightD.shadow.camera.bottom=-2,lightD.shadow.camera.left=-2,scene.add(lightD);const renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0});renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.xr.enabled=!0,document.body.appendChild(renderer.domElement),controller=renderer.xr.getController(0),controller.addEventListener("select",onSelect),scene.add(controller);const reticle=new THREE.Mesh(new THREE.RingGeometry(.15,.2,32).rotateX(-Math.PI/2),new THREE.MeshBasicMaterial);function onSesS(e){console.log("ar started");const t=scene.getObjectByName("Instruct Plane");scene.remove(t);scene.getObjectByName("Hemi").intensity=2.2}function onSesE(e){}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function firstClick(){const e=scene.getObjectByName("Landing Plane");scene.remove(e),makeInstruct(),document.body.appendChild(ARButton.createButton(renderer,{requiredFeatures:["hit-test"]})),document.getElementById("overlay").remove(),document.removeEventListener("click",firstClick)}function shaked(){console.log("shaked..."),boxSnowArray.forEach((function(e){scene.remove(e)})),clampHeight=.3,sound.play(),addStars(globeNext.position.x,globeNext.position.y,globeNext.position.z),stars=!0,still=!1}function onSelect(){if(reticle.visible&&0==treePresenet){const e=scene.getObjectByName("Globe");globeNext=e.clone(),globeNext.position.setFromMatrixPosition(reticle.matrix),globeNext.visible=!0,scene.add(globeNext),console.log(globeNext.position.x,globeNext.position.y,globeNext.position.z);const t=scene.getObjectByName("Reticle");scene.remove(t),treePresenet=!0}}function animate(){renderer.setAnimationLoop(render)}function render(e,t){const o=clock.getDelta();if(t){const e=renderer.xr.getReferenceSpace(),o=renderer.xr.getSession();if(!1===hitTestSourceRequested&&(o.requestReferenceSpace("viewer").then((function(e){o.requestHitTestSource({space:e}).then((function(e){hitTestSource=e}))})),o.addEventListener("end",(function(){hitTestSourceRequested=!1,hitTestSource=null})),hitTestSourceRequested=!0),hitTestSource){const o=t.getHitTestResults(hitTestSource);if(o.length){const t=o[0];reticle.visible=!0,reticle.matrix.fromArray(t.getPose(e).transform.matrix)}else reticle.visible=!1}}if(console.log("still",still),1==stars){if(clampHeight-=2e-4,clampHeight<globeNext.position.y){still=!0;for(let e=0;e<boxSnowArray.length;e++){boxSnowArray[e].position.y=globeNext.position.y+.02}return void(stars=!1)}if(0==still)for(let e=0;e<boxSnowArray.length;e++){const t=boxSnowArray[e],n=globeNext.position.x,i=globeNext.position.y,r=globeNext.position.z;let s=t.userData.velocity.multiplyScalar(1-.1*o);t.position.add(s),(t.position.x<n-.075||t.position.x>n+.075)&&(t.position.x=THREE.MathUtils.clamp(t.position.x,n-.075,n+.075),s.x=-s.x),(t.position.y<i||t.position.y>i+clampHeight)&&(t.position.y=THREE.MathUtils.clamp(t.position.y,i,i+clampHeight),s.y=-s.y),(t.position.z<r-.075||t.position.z>r+.075)&&(t.position.z=THREE.MathUtils.clamp(t.position.z,r-.075,r+.075),s.z=-s.z),t.rotation.x+=2*s.x*o,t.rotation.y+=2*s.y*o,t.rotation.z+=2*s.z*o}}renderer.render(scene,camera)}function makeBase(){const e=[];e.push(new THREE.Vector2(.4,0)),e.push(new THREE.Vector2(.4,.08)),e.push(new THREE.Vector2(.35,.08)),e.push(new THREE.Vector2(.35,.12)),e.push(new THREE.Vector2(.375,.12)),e.push(new THREE.Vector2(.375,.18));const t=new THREE.LatheGeometry(e),o=new THREE.MeshLambertMaterial({color:5056e3}),n=new THREE.Mesh(t,o);n.castShadow=!0,n.receiveShadow=!0,globeGroup.add(n);const i=new THREE.CylinderGeometry(.4,.4,2e-4,32),r=new THREE.Mesh(i,o);globeGroup.add(r);const s=new THREE.CylinderGeometry(.375,.375,2e-4,32),a=new THREE.Mesh(s,o);a.position.set(0,.18,0),globeGroup.add(a);const l=new THREE.SphereGeometry(.5,32,16,0,2*Math.PI,0,2.4),c=new THREE.MeshPhysicalMaterial({roughness:0,transmission:1,thickness:.5}),d=new THREE.Mesh(l,c);d.position.set(0,.55,0),globeGroup.add(d);const h=new THREE.Vector3(0,.3,0),p=new THREE.Vector3(.04,.04,.04),u=new THREE.Euler(-90*Math.PI/180,0*Math.PI/180,90*Math.PI/180);gltfLoader.load("./media/Tree/scene.gltf",(e=>((e,t,o,n,i)=>{console.log("GLTF",e);const r=e.scenes[0].children[0];r.position.copy(t),r.scale.copy(o),r.setRotationFromEuler(n),r.name=i,r.traverse((function(e){e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),globeGroup.add(r)})(e,h,p,u,"Tree")),(e=>{console.log(e.loaded/e.total*100+"%")}),(e=>{console.log(e)})),globeGroup.scale.set(.3,.3,.3),globeGroup.visible=!1,globeGroup.name="Globe",scene.add(globeGroup),console.log("globe Group; ",globeGroup)}function addStars(e,t,o){for(let n=0;n<150;n++){const n=[],i=5;for(let e=0;e<2*i;e++){const t=e%2==1?10:20,o=e/i*Math.PI;n.push(new THREE.Vector2(Math.cos(o)*t,Math.sin(o)*t))}const r=new THREE.Shape(n),s=new THREE.ShapeGeometry(r);s.scale(.001,.001,.001);const a=new THREE.Mesh(s,new THREE.MeshLambertMaterial({color:16777215*Math.random()}));a.position.x=e,a.position.y=t-.05,a.position.z=o,a.rotation.x=e+2*Math.random()*Math.PI,a.rotation.y=t+2*Math.random()*Math.PI,a.rotation.z=o+2*Math.random()*Math.PI,a.scale.x=.3*(Math.random()+.5),a.scale.y=.3*(Math.random()+.5),a.scale.z=.3*(Math.random()+.5),a.userData.velocity=new THREE.Vector3,a.userData.velocity.x=.0025*Math.random(),a.userData.velocity.y=.0025*Math.random(),a.userData.velocity.z=.0025*Math.random(),boxSnowArray.push(a),scene.add(a)}}function makeLanding(){const e=textureLoader.load("media/landing.webp"),t=new THREE.PlaneGeometry(1,1,32,32),o=new THREE.MeshLambertMaterial({map:e}),n=new THREE.Mesh(t,o);n.position.set(0,0,.5),n.name="Landing Plane",scene.add(n)}function makeInstruct(){const e=textureLoader.load("media/instruct.webp"),t=new THREE.PlaneGeometry(1,1,32,32),o=new THREE.MeshLambertMaterial({map:e}),n=new THREE.Mesh(t,o);n.position.set(0,0,.5),n.name="Instruct Plane",scene.add(n)}reticle.matrixAutoUpdate=!1,reticle.visible=!1,reticle.name="Reticle",scene.add(reticle),makeLanding(),makeBase(),renderer.xr.addEventListener("sessionstart",onSesS),renderer.xr.addEventListener("sessionend",onSesE),window.addEventListener("resize",onWindowResize),document.addEventListener("click",firstClick),window.addEventListener("shake",shaked),animate();class ARButton{static createButton(e,t={}){const o=document.createElement("button");function n(){o.style.display="",o.style.cursor="auto",o.style.left="calc(50% - 75px)",o.style.width="150px",o.onmouseenter=null,o.onmouseleave=null,o.onclick=null,o.textContent="AR NOT SUPPORTED"}function i(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return o.id="ARButton",o.style.display="none",i(o),navigator.xr.isSessionSupported("immersive-ar").then((function(i){i?function(){if(void 0===t.domOverlay){var n=document.createElement("div");n.style.display="none",document.body.appendChild(n);var i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("width",38),i.setAttribute("height",38),i.style.position="absolute",i.style.right="20px",i.style.top="20px",i.addEventListener("click",(function(){s.end()})),n.appendChild(i);var r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),r.setAttribute("stroke","#fff"),r.setAttribute("stroke-width",2),i.appendChild(r),void 0===t.optionalFeatures&&(t.optionalFeatures=[]),t.optionalFeatures.push("dom-overlay"),t.domOverlay={root:n}}let s=null;async function a(n){n.addEventListener("end",l),e.xr.setReferenceSpaceType("local"),await e.xr.setSession(n),o.textContent="STOP AR",t.domOverlay.root.style.display="",s=n}function l(){s.removeEventListener("end",l),o.textContent="START AR",t.domOverlay.root.style.display="none",s=null}o.style.display="",o.style.cursor="pointer",o.style.left="calc(50% - 50px)",o.style.width="100px",o.textContent="START AR",o.onmouseenter=function(){o.style.opacity="1.0"},o.onmouseleave=function(){o.style.opacity="0.5"},o.onclick=function(){null===s?navigator.xr.requestSession("immersive-ar",t).then(a):s.end()}}():n()})).catch(n),o;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",i(e),e}}}export{ARButton};