import*as THREE from"../../js/three.module.js";import{VRButton}from"./04_js/hang_VRButton.mjs";import{OrbitControls}from"../../js/OrbitControls.mjs";import{addPicTitle,makePicReplay,makePicCat,makePicDrag}from"./04_js/hang_pics.mjs";import{addLights}from"./04_js/hang_basics.mjs";import{makePicAlpha1,makePicAlpha2,makePicAlpha3}from"./04_js/hang_makeAlpha.mjs";import{worder}from"./04_js/hang_makeWord.mjs";import{makeCross}from"./04_js/hang_cross.mjs";window.THREE=THREE;export const scene=new THREE.Scene;export let camera;export let controller;export var wrdArr=[];export let theWord;export const cities=["AMSTERDAM","ATHENS","BARCELONA","BERLIN","CASABLANCA","CHICAGO","COPENHAGEN","DUBROVNIK","DUBLIN","EDINBURGH","FLORENCE","GLASGOW","HAVANA","HELSINKI","HOUSTON","ISTANBUL","JAKARTA","KATHMANDU","LONDON","MELBOURNE","MOMBASA","MONTREAL","MOSCOW","MUMBAI","NEWCASTLE","PARIS","PRAGUE","SANTIAGO","SEATTLE","SEOUL","SHANGHAI","STOCKHOLM","TOKYO","TORONTO","VANCOUVER"];export let nextNum=0;export let clickRoom=[];var cloneCR=[];export var crosses=[];export const AlphaGrp=new THREE.Group;export const groupBlackHole=new THREE.Group;const raycaster=new THREE.Raycaster,intersected=[];export const tempMatrix=new THREE.Matrix4;const sparklers=[];var cameraTarget;let container,renderer;const soundClick=new Howl({src:["04_media/audio/LV-HTIS Beeps Simple 03.wav"],volume:.05}),soundCorrect=new Howl({src:["04_media/audio/hangManCorrect.wav"],volume:.05}),soundWrong=new Howl({src:["04_media/audio/hangManWrong.wav"],volume:.05}),soundWin=new Howl({src:["04_media/audio/hangManWin.mp3"],volume:.2}),soundWin2=new Howl({src:["04_media/audio/hangManWin2.mp3"],volume:.05}),soundLose=new Howl({src:["04_media/audio/hangManLose.mp3"],volume:.2});function init(){container=document.createElement("div"),document.body.appendChild(container),scene.background=new THREE.Color(14474460),scene.add(AlphaGrp),scene.add(groupBlackHole),(camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,.1,1e3)).position.set(0,1.25,2.5),cameraTarget=new THREE.Vector3(0,1.65,1),addLights(),addPicTitle(),(renderer=new THREE.WebGLRenderer({antialias:!0})).setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,renderer.xr.enabled=!0,container.appendChild(renderer.domElement),document.body.appendChild(VRButton.createButton(renderer)),controller=renderer.xr.getController(0),scene.add(controller);var e=new THREE.LineBasicMaterial({color:0}),r=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,-1)]),t=new THREE.Line(r,e);t.name="line",t.scale.z=5,controller.add(t.clone()),window.addEventListener("resize",onWindowResize,!1),controller.addEventListener("selectstart",onSelectStart),controller.addEventListener("selectend",onSelectEnd),document.addEventListener("click",()=>{})}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function checkForWin(){for(var e="",r=0;r<theWord.length;r++)e+="z";if(e===wrdArr.join("")){console.log("win"),soundWin2.play(),soundWin.play(),nextNum=0,clickRoom.length=0;var t=scene.getObjectByName("rp");clickRoom.push(t),scene.traverse(function(e){!0===e.userData.isSpacer&&sparklers.push(e)})}sparklers.length>0&&setTimeout(function(){sparklers.length=0},5e3)}function intersectObjects(e){if(void 0===e.userData.selected){var r=e.getObjectByName("line"),t=getIntersections(e);if(t.length>0){var o=t[0],n=o.object;n.material.emissive.b=1,intersected.push(n),r.scale.z=o.distance}else r.scale.z=5}}function getIntersections(e){return tempMatrix.identity().extractRotation(e.matrixWorld),raycaster.ray.origin.setFromMatrixPosition(e.matrixWorld),raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix),raycaster.intersectObjects(clickRoom,!0)}function cleanIntersected(){for(;intersected.length;){intersected.pop().material.emissive.b=0}}function onSelectStart(e){soundClick.play();var r=e.target,t=getIntersections(r);if(t.length>0){var o=t[0];tempMatrix.getInverse(r.matrixWorld);var n=o.object;switch(n.name){case"startMesh":makePicAlpha1(),makePicAlpha2(),makePicAlpha3(),makePicReplay(),makePicCat(),makePicDrag(),makeCross();var a=scene.getObjectByName("tcs");scene.remove(a);var s=scene.getObjectByName("startMesh");s.position.set(0,-2,5),s.scale.set(.001,.001,.01),renderer.renderLists.dispose(),worder.set(),theWord=worder.get(),wrdArr=Array.from(theWord);break;case"rp":if(nextNum=0,setTimeout(function(){for(var e=AlphaGrp.children.length,r=0;r<e;r++){var t=AlphaGrp.children[r],o=new THREE.Vector3(t.userData.homePosX,t.userData.homePosY,t.userData.homePosZ);t.position.set(o.x,o.y,o.z),t.scale.set(1,1,1),t.material.transparent=!1}},1500),groupBlackHole.children.length>0)for(var i=groupBlackHole.children.length,c=0;c<i;c++){var l=groupBlackHole.children[c];l.position.set(0,-2,1),l.scale.set(.001,.001,.01)}for(c=0;c<wrdArr.length;c++){var d=scene.getObjectByName(`spacerMesh${c}`);scene.remove(d)}worder.set(),theWord=worder.get(),wrdArr=Array.from(theWord);for(c=0;c<AlphaGrp.children.length;c++)clickRoom.push(AlphaGrp.children[c]);crosses.forEach(function(e){const r=e.material;e.material=new THREE.MeshBasicMaterial({transparent:!0,opacity:.1,map:r.map})});break;default:n.matrix.premultiply(tempMatrix),n.matrix.decompose(n.position,n.quaternion,n.scale),n.material.emissive.b=1,n.material.color.setHex=16777215,r.add(n),r.userData.selected=n}}}function onSelectEnd(e){var r=e.target;if(void 0!==r.userData.selected){var t=r.userData.selected;switch(t.matrix.premultiply(r.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale),t.material.emissive.b=0,AlphaGrp.add(t),r.userData.selected=void 0,t.name){case"startMesh":console.log("on select end start");break;case"rp":console.log("on select end replay");break;default:var o=scene.getObjectByName("dragMesh");t.position.copy(o.position),t.rotation.set(0,0*Math.PI/180,0),t.translateZ(.01);var n=new THREE.Vector3(t.userData.homePosX,t.userData.homePosY,t.userData.homePosZ),a=wrdArr.includes(t.name);if(!0===a){soundCorrect.play(),console.log("object name",t.name,typeof t.name);const e=wrdArr.filter(e=>e===t.name);console.log("match",e,e.length);var s=wrdArr.findIndex(e=>e===t.name);console.log("inst",s),scene.getObjectByName(`spacerMesh${s}`).material.color.setHex(11119017),wrdArr.splice(s,1,"z"),console.log("splice",wrdArr);var i=scene.getObjectByName(`spacerMesh${s}`).position;console.log("tarCoords",i);new TWEEN.Tween(t.position).to({x:i.x,y:i.y,z:i.z+.01},1e3).start();if(e.length>1)for(var c=0;c<e.length-1;c++){var l=t.clone();groupBlackHole.add(l),l.name=`newLet${c+1}`,l.position.x=.0025*c;var d=wrdArr.findIndex(e=>e===t.name);scene.getObjectByName(`spacerMesh${d}`).material.color.setHex(11119017),wrdArr.splice(d,1,"z");var m=scene.getObjectByName(`spacerMesh${d}`).position;new TWEEN.Tween(l.position).to({x:m.x,y:m.y,z:m.z+.01},1e3).start()}setTimeout(function(){checkForWin()},1200)}}if(!1===a){console.log(a),soundWrong.play();new TWEEN.Tween(t.position).to({x:n.x,y:n.y,z:n.z},1e3).start();t.scale.set(.5,.5,.5),t.material.transparent=!0,t.material.opacity=.25,AlphaGrp.add(t),nextNum+=1,scene.getObjectByName(`Cross${nextNum-1}`).material.transparent=!1,setTimeout(function(){if(8===nextNum){soundLose.play(),nextNum=0,console.log("loser time 1"),clickRoom.length=0;var e=scene.getObjectByName("rp");clickRoom.push(e);for(var r=0;r<wrdArr.length;r++)if("z"===wrdArr[r])console.log("z here",wrdArr[r],r);else{console.log("wrdArr[i]",wrdArr[r]);var t=wrdArr[r],o=scene.getObjectByName(wrdArr[r]);scene.getObjectByName(`spacerMesh${r}`).material.color.setHex(11119017),wrdArr.splice(r,1,"z");var n=scene.getObjectByName(`spacerMesh${r}`).position;new TWEEN.Tween(o.position).to({x:n.x,y:n.y,z:n.z+.01},1e3).start();if(!0===wrdArr.includes(t)){var a=scene.getObjectByName(t).clone();groupBlackHole.add(a);var s=scene.getObjectByName(`spacerMesh${r}`).position;a.position.set(s.x,s.y,s.z+.01)}else console.log("all done")}}},500)}}}function animate(){renderer.setAnimationLoop(render)}function render(){if(TWEEN.update(),cleanIntersected(),intersectObjects(controller),renderer.render(scene,camera),sparklers.length>0)for(var e=0;e<sparklers.length;e++){sparklers[e].material.color.setHex(16777215*Math.random())}}init(),animate();